# Toolchain (Rust) image
FROM ubuntu:20.04 AS toolchain

ARG DEBIAN_FRONTEND=noninteractive

#ToDo test without alpine-sdk, libressl-dev

# Install system prerequisites
RUN apk update && apk upgrade install && apk add \
  alpine-sdk \
  build-base\
  curl \
  cmake \
  clang \
  git \
  bash \
  gmp-dev \
  openssl-dev\
  libressl-dev \
  llvm \
  lld \
  pkgconfig \


# Install Rust
RUN curl https://sh.rustup.rs -sSf | sh -s -- --default-toolchain stable -y

# Add .cargo/bin to PATH
ENV PATH="/root/.cargo/bin:${PATH}"

# Install cargo libraries
RUN cargo install toml-cli
RUN cargo install sccache

# Builder image
FROM toolchain as builder

WORKDIR /libra

# Clone given release tag or branch of this repo
ARG BRANCH=v5.0.12-rc.3
# Fixme(nourspace): depending where these tools are hosted, we might not need to pull
RUN git clone --branch ${BRANCH} --depth 1 https://github.com/OLSF/libra.git /libra

# Build 0L binaries
RUN RUSTC_WRAPPER=sccache make bins

# Production image
# Todo(nourspace): find a smaller base image
FROM ubuntu:20.04 AS prod

# Install system prerequisites
RUN apt-get update && apt-get install -y \
  curl \
  libssl1.1 \
  && apt-get clean && rm -rf /var/lib/apt/lists/*

ENV PATH="/0L/bin:${PATH}"

# Copy binaries from builder
COPY --from=builder [ \
  "/libra/target/release/tower", \
  "/libra/target/release/diem-node", \
  "/libra/target/release/db-restore", \
  "/libra/target/release/db-backup", \
  "/libra/target/release/db-backup-verify", \
  "/libra/target/release/ol", \
  "/libra/target/release/txs", \
  "/libra/target/release/onboard", \
  "/0L/bin/" \
]

WORKDIR /root/.0L
